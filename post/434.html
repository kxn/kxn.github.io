<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=referrer content="no-referrer-when-downgrade">
<title>CentOS 7 在线升级 CentOS 8 | Kxn's eXercise Notes</title>
<meta property="og:title" content="CentOS 7 在线升级 CentOS 8 - Kxn's eXercise Notes">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-06-13T10:10:14+08:00">
<meta property="article:modified_time" content="2020-06-13T10:10:14+08:00">
<meta name=Keywords content>
<meta name=description content="CentOS 7 在线升级 CentOS 8">
<meta name=author content="kxn">
<meta property="og:url" content="https://blog.kangkang.org/post/434.html">
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=stylesheet href=/css/normalize.css>
<link rel=stylesheet href=/css/style.css>
<script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link rel=stylesheet href=/css/douban.css>
<link rel=stylesheet href=/css/other.css>
</head>
<body>
<header id=header class=clearfix>
<div class=container>
<div class=col-group>
<div class=site-name>
<a id=logo href=https://blog.kangkang.org>
Kxn's eXercise Notes
</a>
<p class=description>Knowledge Sharing</p>
</div>
<div>
<nav id=nav-menu class=clearfix>
<a class=current href=https://blog.kangkang.org>首页</a>
<a href=https://blog.kangkang.org/archives/ title=归档>归档</a>
<a href=https://blog.kangkang.org/about-me/ title="About Me">About Me</a>
</nav>
</div>
</div>
</div>
</header>
<div id=body>
<div class=container>
<div class=col-group>
<div class=col-8 id=main>
<div class=res-cons>
<article class=post>
<header>
<h1 class=post-title>CentOS 7 在线升级 CentOS 8</h1>
</header>
<date class="post-meta meta-date">
2020年6月13日
</date>
<div class=post-meta>
<span>|</span>
<span class=meta-category><a href=/categories/Tech-Notes>Tech Notes</a></span>
</div>
<div class=post-meta>
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span>
</div>
<div class=post-content>
<p>CentOS7 上的软件逐渐已经开始落后于时代。虽然 CentOS 8 出来的时间还没有那么多，可能还需要很多小白鼠的考验。但是按照以前经验，已经需要开始试用了。</p>
<p>和 6 在线升 7 不一样，7 在线升 8 是没有官方支持的，只是能用而已，所以搞之前务必小心。</p>
<p>参考的基本贴是这里https://www.tecmint.com/upgrade-centos-7-to-centos-8/</p>
<p>操作命令</p>
<p>0: 干啥先备份，死了还有得救</p>
<p>0.5: 请尽可能卸载系统上所有非官方的 rpm 包和 repository，如果安装了第三方内核，并且当前启动在第三方内核下面的话，请重启进入 CentOS 7 原生的 3.10 内核，然后卸载第三方内核的 rpm 包。</p>
<p>0.8: <strong>警告，实体机目前有可能会出现重启没驱动找不到盘的现象，原因还没仔细研究，慎重！</strong></p>
<p>1: 首先安装 epel-release，已经装过了的请跳过</p>
<blockquote>
<p>yum -y install epel-release</p>
</blockquote>
<p>2: 安装 yum-utils (为了使用 package-cleanup) 和 rpmconf</p>
<blockquote>
<p>yum -y install yum-utils rpmconf</p>
</blockquote>
<p>3: 首先用 rpmconf 来检查所有 rpm 配置文件</p>
<blockquote>
<p>rpmconf -a</p>
</blockquote>
<p>会不断询问一些配置文件你要使用原始的版本（按 Y），还是保留你修改过的（按 N），原则是尽量使用原始的版本，如果影响比较大，比如改了 ssh 端口之外的，就保留自己的</p>
<p>4: 卸载 rpmconf，已经没用了</p>
<blockquote>
<p>yum -y remove python36-rpmconf rpmconf</p>
</blockquote>
<p>5: 用 package-cleanup 检查有没有没用的 rpm</p>
<blockquote>
<p>package-cleanup &ndash;leaves</p>
</blockquote>
<p>这个出来的 rpm 大部分都可以安全卸载，将用不到的卸掉，但是卸载时候注意看会不会有系统关键 rpm 被卸载，有的话跳过就行，这一步不一定都要卸干净</p>
<blockquote>
<p>package-cleanup &ndash;orphans</p>
</blockquote>
<p>这一步出来的 rpm 一般是内核和你自行安装的第三方 rpm , 看情况卸载，内核可以不用管, 这一步也是不一定要卸载干净</p>
<p>6: 安装 dnf</p>
<blockquote>
<p>yum -y install dnf</p>
</blockquote>
<p>7: 卸载 yum</p>
<blockquote>
<p>dnf -y remove yum yum-metadata-parser<br>
rm -rf /etc/yum</p>
</blockquote>
<p>8: 用 dnf 把系统更新到最新</p>
<blockquote>
<p>dnf -y upgrade</p>
</blockquote>
<p>9: 安装 CentOS 8 的基础信息 rpm</p>
<blockquote>
<p>dnf -y install <a href=http://mirror.centos.org/centos/8/BaseOS/x86>http://mirror.centos.org/centos/8/BaseOS/x86</a>_64/os/Packages/centos-repos-8.2-2.2004.0.1.el8.x86_64.rpm <a href=http://mirror.centos.org/centos/8/BaseOS/x86>http://mirror.centos.org/centos/8/BaseOS/x86</a>_64/os/Packages/centos-release-8.2-2.2004.0.1.el8.x86_64.rpm <a href=http://mirror.centos.org/centos/8/BaseOS/x86_64/os/Packages/centos-gpg-keys-8.2-2.2004.0.1.el8.noarch.rpm>http://mirror.centos.org/centos/8/BaseOS/x86_64/os/Packages/centos-gpg-keys-8.2-2.2004.0.1.el8.noarch.rpm</a></p>
</blockquote>
<p>如果报告文件找不到，那么可能是 CentOS 又升级了，去对应的目录下面找到正确的文件名即可</p>
<p>10: 升级 epel 的 rpm</p>
<blockquote>
<p>dnf -y upgrade <a href=http://hkg.mirror.rackspace.com/epel/epel-release-latest-8.noarch.rpm>http://hkg.mirror.rackspace.com/epel/epel-release-latest-8.noarch.rpm</a></p>
</blockquote>
<p>11: 卸载 CentOS7 内核和冲突的 sysvinit 脚本</p>
<blockquote>
<p>rpm -e `rpm -q kernel`<br>
rpm -e &ndash;nodeps sysvinit-tools</p>
</blockquote>
<p>12: 清理 /etc/yum.repos.d 下面的 repo 文件，将 CentOS- 系列 repo 文件都恢复成原始版本(看到有扩展名是 .rpmnew 的，就用 .rpmnew 覆盖掉对应文件) 将 epel.repo 也恢复成原始版本。</p>
<p>13: 进行主要升级</p>
<blockquote>
<p>dnf -y &ndash;releasever=8 &ndash;allowerasing &ndash;setopt=deltarpm=false distro-sync</p>
</blockquote>
<p>这步是最容易出问题的，经常会报各种奇怪错误，请参考后面的常见问题</p>
<p>14: 安装内核</p>
<blockquote>
<p>dnf -y install kernel-core kernel-modules</p>
</blockquote>
<p>15: 把 minimal 组给装上</p>
<blockquote>
<p>dnf -y groupupdate &ldquo;Core&rdquo; &ldquo;Minimal Install&rdquo;</p>
</blockquote>
<p>16: 找出系统上其余 el7 的 rpm 包，将其卸载</p>
<blockquote>
<p>rpm -qa |grep el7 | xargs dnf remove</p>
</blockquote>
<p>会报告所有需要卸载的软件包，记下对你有用的那些，再次执行</p>
<blockquote>
<p>rpm -qa |grep el7 | xargs dnf -y remove</p>
</blockquote>
<p>来真正卸载</p>
<p>17: 启用 NetworkManager 并禁用 initscript 的网络初始化，不少 CentOS 7 的安装或多或少是禁用了 NetworkManager 或者依赖于 initscript 的，这种安装如果升级不做这个的话，有可能重启网络起不来。</p>
<blockquote>
<p>systemctl enable NetworkManager<br>
systemctl disable network</p>
</blockquote>
<p>18: 重启系统，把前面所有卸掉的有用软件包全都装回来，配置文件可能需要手工恢复一下，不用着急，一般都会用 .rpmsave 扩展名保存一个备份的。</p>
<p>常见问题</p>
<ul>
<li>
<p>报告会导致受保护的软件包 dnf 被移除<br>
一般是 /etc/yum.repos.d 没清理干净，尤其是 CentOS 的 repo 文件是旧的，导致没法升级 dnf，请清理 repo 文件</p>
</li>
<li>
<p>报告会导致受保护的软件包 kernel-ml 被移除<br>
是因为你没听我的，在第三方内核启动状态状态下执行了升级，重启进 rescue 内核吧。能不能起得来就看你人品了。</p>
</li>
<li>
<p>报告 anonbin 和 redhat-rpm-config 依赖错误<br>
删掉所有 kernel-devel 就好了。（和一个好的机器对比了半天终于找出来的）</p>
</li>
</ul>
<blockquote>
<p>rpm -qa |grep kernel-devel | xargs rpm -e</p>
</blockquote>
<ul>
<li>重启以后 pppoe 拨号起不来<br>
原因是 CentOS 8 开始强推 NetworkManager 了， 虽然给了 network-scripts 这个包用来保持向下兼容性，但是也就只是能在有线网卡上用用而已，对于 pppoe 等冷门连接方式，你只能用 NetworkManager 了.<br>
对于 pppoe 连接，你需要单独安装 NetworkManager-ppp 这个包</li>
</ul>
<blockquote>
<p>dnf -y install NetworkManager-ppp</p>
</blockquote>
<p>一个好消息是 CentOS 8 上面不再需要 rp-pppoe 这个包来做内核 pppoe 了，直接配直接就是可用的。</p>
<ul>
<li>Zabbix agent 没了怎么办<br>
CentOS 8 上面有 zabbix40 系列的包，可以用 dnf 装这个，但是一般来说 CentOS 7 上还是用 3.x zabbix 比较多，而 4.x 的 agent 是不能和 3.x zabbix 一起用的，所以直接去 Zabbix 的官网下载 3.x 的 rpm 就可以了。</li>
</ul>
</div>
<div class="post-meta meta-tags">
没有标签
</div>
</article>
</div>
<footer id=footer>
<div>
&copy; 2021 <a href=https://blog.kangkang.org>Kxn's eXercise Notes By kxn</a>
</div>
<br>
<div>
<div class=github-badge>
<a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
</div>
<div class=github-badge>
<a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
</div>
<div class=github-badge>
<a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
</div>
</div>
</footer>
<script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:!0}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script src=/js/douban.js></script>
</div>
<div id=secondary>
<section class=widget>
<form id=search action=https://blog.kangkang.org/search/ method=get accept-charset=utf-8 target=_blank _lpchecked=1>
<input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://blog.kangkang.org>
<button type=submit class="submit icon-search"></button>
</form>
</section>
<section class=widget>
<h3 class=widget-title>最近文章</h3>
<ul class=widget-list>
<li>
<a href=https://blog.kangkang.org/post/557.html title="MSI B550 暗黑版跑黑苹果">MSI B550 暗黑版跑黑苹果</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/553.html title="最简单的打造一台能够 RenderDoc 的手机">最简单的打造一台能够 RenderDoc 的手机</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/541.html title="编译 RenderDoc 的安卓 apk(带interceptor-lib)">编译 RenderDoc 的安卓 apk(带interceptor-lib)</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/532.html title=Linux下解决同一硬盘因为连接设备不一样导致扇区大小不一致的问题>Linux下解决同一硬盘因为连接设备不一样导致扇区大小不一致的问题</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/529.html title="RHEL/CentOS/OracleLinux 8  yum 能看到，安装却没有的情况">RHEL/CentOS/OracleLinux 8 yum 能看到，安装却没有的情况</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/521.html title=让服务器响应整个网段中的请求>让服务器响应整个网段中的请求</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/514.html title="不要买技嘉 X570 Gaming X 主板">不要买技嘉 X570 Gaming X 主板</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/509.html title="Golang socket 里面奇怪的 pipe 使用">Golang socket 里面奇怪的 pipe 使用</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/504.html title=用RenderDoc和安卓模拟器抓帧手游>用RenderDoc和安卓模拟器抓帧手游</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/500.html title="解决 Mac 电脑原生 EFI 安装 Windows 启动很慢的问题">解决 Mac 电脑原生 EFI 安装 Windows 启动很慢的问题</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/categories/>分类</a></h3>
<ul class=widget-list>
<li><a href=https://blog.kangkang.org/categories/Coding/>Coding (12)</a></li>
<li><a href=https://blog.kangkang.org/categories/Entertainment/>Entertainment (5)</a></li>
<li><a href=https://blog.kangkang.org/categories/Network/>Network (33)</a></li>
<li><a href=https://blog.kangkang.org/categories/Pictures/>Pictures (2)</a></li>
<li><a href=https://blog.kangkang.org/categories/Software/>Software (27)</a></li>
<li><a href=https://blog.kangkang.org/categories/Tech-Notes/>Tech Notes (174)</a></li>
<li><a href=https://blog.kangkang.org/categories/Uncategorized/>Uncategorized (30)</a></li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/tags/>标签</a></h3>
<div class=tagcloud>
<a href=https://blog.kangkang.org/tags/.xsession-errors/>.xsession-errors</a>
<a href=https://blog.kangkang.org/tags/139/>139</a>
<a href=https://blog.kangkang.org/tags/720/>720</a>
<a href=https://blog.kangkang.org/tags/CentOS/>CentOS</a>
<a href=https://blog.kangkang.org/tags/adsl/>adsl</a>
<a href=https://blog.kangkang.org/tags/aliedit/>aliedit</a>
<a href=https://blog.kangkang.org/tags/bad-design/>bad design</a>
<a href=https://blog.kangkang.org/tags/buggy/>buggy</a>
<a href=https://blog.kangkang.org/tags/chdk-a570-canon/>chdk a570 canon</a>
<a href=https://blog.kangkang.org/tags/cname/>cname</a>
<a href=https://blog.kangkang.org/tags/dns/>dns</a>
<a href=https://blog.kangkang.org/tags/error/>error</a>
<a href=https://blog.kangkang.org/tags/fail/>fail</a>
<a href=https://blog.kangkang.org/tags/filesort/>filesort</a>
<a href=https://blog.kangkang.org/tags/fragrance-hill/>fragrance hill</a>
<a href=https://blog.kangkang.org/tags/google-chrome/>google chrome</a>
<a href=https://blog.kangkang.org/tags/gps/>gps</a>
<a href=https://blog.kangkang.org/tags/gzip/>gzip</a>
<a href=https://blog.kangkang.org/tags/half-duplex/>half duplex</a>
<a href=https://blog.kangkang.org/tags/ipv6-isatap-fedora/>ipv6 isatap fedora</a>
<a href=https://blog.kangkang.org/tags/javascript/>javascript</a>
<a href=https://blog.kangkang.org/tags/jtag-debrick-dell-2300-%E6%97%A0%E7%BA%BF%E8%B7%AF%E7%94%B1%E5%99%A8-%E4%BF%AE%E5%A4%8D-openwrt/>jtag debrick dell 2300 无线路由器 修复 openwrt</a>
<a href=https://blog.kangkang.org/tags/mobile-trail-explorer/>mobile trail explorer</a>
<a href=https://blog.kangkang.org/tags/mysql/>mysql</a>
<a href=https://blog.kangkang.org/tags/mysql-replication/>mysql replication</a>
<a href=https://blog.kangkang.org/tags/optimize/>optimize</a>
<a href=https://blog.kangkang.org/tags/performance/>performance</a>
<a href=https://blog.kangkang.org/tags/pushmail/>pushmail</a>
<a href=https://blog.kangkang.org/tags/query-cache/>query cache</a>
<a href=https://blog.kangkang.org/tags/qwerty/>qwerty</a>
<a href=https://blog.kangkang.org/tags/remote-backup/>remote backup</a>
<a href=https://blog.kangkang.org/tags/shortcut/>shortcut</a>
<a href=https://blog.kangkang.org/tags/slow-machine/>slow machine</a>
<a href=https://blog.kangkang.org/tags/sony-ericsson-m600i/>sony ericsson m600i</a>
<a href=https://blog.kangkang.org/tags/ssl/>ssl</a>
<a href=https://blog.kangkang.org/tags/trackback/>trackback</a>
<a href=https://blog.kangkang.org/tags/ucweb-6.3/>ucweb 6.3</a>
<a href=https://blog.kangkang.org/tags/unstable/>unstable</a>
<a href=https://blog.kangkang.org/tags/wildcard/>wildcard</a>
<a href=https://blog.kangkang.org/tags/xp/>xp</a>
<a href=https://blog.kangkang.org/tags/%E4%B8%93%E4%B8%9A%E7%89%88/>专业版</a>
<a href=https://blog.kangkang.org/tags/%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/>安全问题</a>
<a href=https://blog.kangkang.org/tags/%E6%8B%9B%E8%A1%8C/>招行</a>
<a href=https://blog.kangkang.org/tags/%E6%96%90%E8%AE%AFN1/>斐讯N1</a>
<a href=https://blog.kangkang.org/tags/%E9%A9%B1%E5%8A%A8/>驱动</a>
</div>
</section>
<section class=widget>
<h3 class=widget-title>友情链接</h3>
<ul class=widget-list>
<li>
<a target=_blank href=https://blog.kangkang.net/ title=我的非技术blog>我的非技术blog</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title>其它</h3>
<ul class=widget-list>
<li><a href=https://blog.kangkang.org/index.xml>文章 RSS</a></li>
</ul>
</section>
</div>
</div>
</div>
</div>
</body>
</html>