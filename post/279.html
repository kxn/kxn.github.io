<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=referrer content="no-referrer-when-downgrade">
<title>用一台MW4530R搞定北京联通IPTV FTTB接入 | Kxn's eXercise Notes</title>
<meta property="og:title" content="用一台MW4530R搞定北京联通IPTV FTTB接入 - Kxn's eXercise Notes">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2013-10-07T02:53:00+08:00">
<meta property="article:modified_time" content="2013-10-07T02:53:00+08:00">
<meta name=Keywords content>
<meta name=description content="用一台MW4530R搞定北京联通IPTV FTTB接入">
<meta name=author content="kxn">
<meta property="og:url" content="https://blogtest.kangkang.org/post/279.html">
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=stylesheet href=/css/normalize.css>
<link rel=stylesheet href=/css/style.css>
<script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link rel=stylesheet href=/css/douban.css>
<link rel=stylesheet href=/css/other.css>
</head>
<body>
<header id=header class=clearfix>
<div class=container>
<div class=col-group>
<div class=site-name>
<a id=logo href=https://blogtest.kangkang.org>
Kxn's eXercise Notes
</a>
<p class=description>Knowledge Sharing</p>
</div>
<div>
<nav id=nav-menu class=clearfix>
<a class=current href=https://blogtest.kangkang.org>首页</a>
<a href=https://blogtest.kangkang.org/archives/ title=归档>归档</a>
<a href=https://blogtest.kangkang.org/about-me/ title="About Me">About Me</a>
</nav>
</div>
</div>
</div>
</header>
<div id=body>
<div class=container>
<div class=col-group>
<div class=col-8 id=main>
<div class=res-cons>
<article class=post>
<header>
<h1 class=post-title>用一台MW4530R搞定北京联通IPTV FTTB接入</h1>
</header>
<date class="post-meta meta-date">
2013年10月7日
</date>
<div class=post-meta>
<span>|</span>
<span class=meta-category><a href=/categories/Tech-Notes>Tech Notes</a></span>
</div>
<div class=post-meta>
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span>
</div>
<div class=post-content>
<p>发现有网站转内容不写来源。。只好加上这个</p>
<p>本文原创于 <a href=http://blog.kangkang.org title=http://blog.kangkang.org>http://blog.kangkang.org</a> ，欢迎转载但请保留来源。</p>
<p>北京联通几个月前开始搞 IPTV 促销，只要 20M 宽带用两年，就可以免费赠送 IPTV。我等羊(dan4)毛(teng2)党自然是第一时间薅下。和大多数人家不一样，我家是 FTTB ，入户的是网线不是光缆。来安装的人带了一个家庭网关接在入户线上，然后其中一个口是专门给 IPTV 的，剩下三个可以接路由器拨号上网。在这个结构里面显然家庭网关这个角色很是多余，就是为了把一根网线上分在不同 VLAN 里面的上网流量和 IPTV 流量给分开到不同的网口。这事情常见的家庭路由器配合相应的软件也是可以做的，而且这个家庭网关明显属于很粗制滥造的那种，和其他联通设备一样，它支持无线，支持路由，只是都被关掉了，通过破解的手段可以打开，但是打开了一天我就被迫又换回去了，因为这玩意当路由用实在太不稳定了，无线也经常掉线。</p>
<p>上网搜了一下，已经有不少资料了，不过基本是南方电信的 IPTV 设置，跟北京的不太一样，偶尔有一两个讲北京的，还是光纤入户用光猫的那种，跟我光纤入楼的情况差别比较大。经过无数次的失败试验（此处省略 N 字，过程实在是太折腾了，几台 RG100A 和主力的 MW4530R 刷挂了不知道多少次)，最终摸清楚了北京联通 FTTB 方式下 IPTV 的接入方式。</p>
<p>光纤入楼和入户最大的区别，就是入楼的之前入户网线里面就只有一路上网流量，而开启 IPTV 以后就变成两路，为了平滑过渡，北京联通搞出来一个非常神奇的机制。平时上网的 PPPOE 走 untagged 流量，这个时候除了 3999 之外其他的 VLAN 都是无效的，你就算发送其他 VLAN 的数据包，也不会有人回应你。而一旦有某个特定 MAC 地址的设备(就是联通送的那个家庭网关)，从 3999 VLAN 上发出 PPPOE 请求，其他几个 VLAN 就被激活了，同时原来 untagged PPPOE 停止响应。在我这里上网的 VLAN 会变成 344，IPTV 是 1544，还有一个 2744 不知道是干啥用的。更坑爹的是，1544 VLAN 上传输的是 IPTV 的控制数据和点播数据，但是通过组播传送过来直播数据则又是 untagged 状态。于是就能看到从 1544 VLAN 上传过去的 igmp 报文，却传过来 untagged 的组播数据。</p>
<p>这个配置看起来相当折腾人，不过在 openwrt 这么灵活的环境里面，还是能配置起来的，但是受限于芯片能力，RG100A-AA 只好下岗，因为他的芯片只支持连续的 16 个 VLAN 同时工作，像 344 1544 这样的没法同时支持。MW4530R 的芯片是支持这么多 VLAN 的，但是代码里面默认只开了 128 个，需要手动修改 linux/drivers/net/phy/ar8216.c 里面的 AR8X16_MAX_VLANS 为 4096。此外 AR 系列芯片的驱动是不支持在同一个网口上面混合 tagged 和 untagged 的流量的，而且据说修改驱动不好使，好在有个变通的方法，他硬件可以给每个网口设定一个 pvid，让硬件把这个端口上 untagged 的流量当做 pvid 这个 vlan 来处理。</p>
<p>另外一个难点是需要在两个 vlan 上进行双拨，用不同的 mac 地址，其中一个要设定为联通家庭网关的 mac，这个搞过双拨的都知道用 macvlan，但是 openwrt 的网络代码部分升级成 netifd 架构以后，macvlan 的支持被丢掉了，手动在 openwrt 的网络脚本里面加命令很容易搞得一团糟。这个没有什么好办法，而且 netifd 几乎没有任何说明文档，硬着头皮啃了半天代码，实现了粗糙的 macvlan 支持，同样设置 pvid 的代码本来 openwrt 里面也有，升级到 netifd 以后也没了，一起实现了一下。</p>
<p>总体初始化流程是</p>
<p>1: 设置 3999 vlan 创建 eth0.3999，绑定 cpu 和 wan port<br>
2: 在 eth0.3999 上创建 eth2 的 macvlan, 设置 mac 为家庭网关<br>
3: 在 eth2 上创建 pppoe 链接，用户名密码是家庭网关的 tr069 账号（见下面配置文件)，但不要设置为默认路由，也不用他的 dns<br>
4: 设置 344 vlan, 绑定 cpu 和 wan port。创建 eth0.344<br>
5: 在 eth0.344 上创建 pppoe 链接，设置为上网用户名密码<br>
6：创建 1544 vlan，绑定 wan port 和 iptv port (untagged)。这个不用绑 cpu port，因为我们只需要交换机硬件转发。<br>
7: 设置 wan port 的 pvid 为 1544</p>
<p>openwrt 需要装上 kmod_macvlan 和 ip 两个包，另外代码需要修改 ar8216.c 的 vlan 个数。 最后还需要 macvlan.sh 和 setpvid.sh，下载来放在 openwrt 的 /lib/netifd/proto 里面，可能需要加执行权限，不确定。</p>
<p>最后我的 /etc/config/network 配置大概如下。 0 口是 cpu, 1 口是 wan, 5 口是 iptv</p>
<blockquote>
<p>config switch<br>
option reset &lsquo;1&rsquo;<br>
option enable_vlan &lsquo;1&rsquo;<br>
option name &lsquo;switch0&rsquo;</p>
<p>config interface &lsquo;loopback&rsquo;<br>
option ifname &lsquo;lo&rsquo;<br>
option proto &lsquo;static&rsquo;<br>
option ipaddr &lsquo;127.0.0.1&rsquo;<br>
option netmask &lsquo;255.0.0.0&rsquo;</p>
<p>config switch_vlan<br>
option vlan &lsquo;1&rsquo;<br>
option ports &lsquo;0t 2 3 4&rsquo;<br>
option device &lsquo;switch0&rsquo;</p>
<p>config interface &lsquo;lan&rsquo;<br>
option ifname &lsquo;eth0.1&rsquo;<br>
option type &lsquo;bridge&rsquo;<br>
option proto &lsquo;static&rsquo;<br>
option ipaddr &lsquo;192.168.1.1&rsquo;<br>
option netmask &lsquo;255.255.255.0&rsquo;</p>
<p>config switch_vlan<br>
option vlan &lsquo;3999&rsquo;<br>
option ports &lsquo;0t 1t&rsquo;<br>
option device &lsquo;switch0&rsquo;</p>
<p>config interface &lsquo;tr069base&rsquo;<br>
option ifname &lsquo;eth0.3999&rsquo;<br>
option proto &lsquo;macvlan&rsquo; # macvlan 支持，需要我做的 macvlan.sh<br>
option device &lsquo;eth2&rsquo;<br>
option hwaddr &lsquo;XX:XX:XX:XX:XX:XX&rsquo; # 家庭网关 mac</p>
<p>config interface &lsquo;tr069&rsquo;<br>
option ifname &lsquo;eth2&rsquo;<br>
option proto &lsquo;pppoe&rsquo;<br>
option username &lsquo;bjcnc-hgw@hgw-nms&rsquo;<br>
option password &lsquo;tr069 密码&rsquo; # 这个值是我监听联通家庭网关得到的，不确定别人的是不是一样，所以不贴了。<br>
option defaultroute &lsquo;0&rsquo;<br>
option peerdns &lsquo;0&rsquo;</p>
<p>config switch_vlan<br>
option vlan &lsquo;344&rsquo;<br>
option ports &lsquo;0t 1t&rsquo;<br>
option device &lsquo;switch0&rsquo;</p>
<p>config interface &lsquo;wan&rsquo;<br>
option ifname &lsquo;eth0.344&rsquo;<br>
option proto &lsquo;pppoe&rsquo;<br>
option username &lsquo;adsl 拨号用户名&rsquo;<br>
option password &lsquo;adsl 拨号密码&rsquo;</p>
<p>config switch_vlan<br>
option vlan &lsquo;1544&rsquo;<br>
option ports &lsquo;1t 5&rsquo;<br>
option device &lsquo;switch0&rsquo;</p>
<p>config interface &lsquo;iptv&rsquo;<br>
option ifname &lsquo;eth0.1544&rsquo;<br>
option proto &lsquo;setpvid&rsquo; # 实现的 pvid 支持，需要 setpvid.sh<br>
option device &lsquo;switch0&rsquo;<br>
option port &lsquo;1&rsquo;<br>
option pvid &lsquo;1544&rsquo;</p>
</blockquote>
<p>话说如果是光纤到户，用光猫的一般就不用这么费劲了，买一个支持直接分 vlan 的光猫就可以了。这个实在是太折腾了。。。</p>
<p>Update: 刚刚 Build 了一个都改好的 mw4530r 固件，有兴趣的可以从这里下载，不过不是 12.09 release 的，是 trunk 里面的当前最新版本，12.09 release 在我这里跟 ubuntu 的 sky2 驱动有兼容问题，ubuntu 网卡流量一大驱动就会出错，路由器固件升级到 trunk 就没这毛病了。</p>
</div>
<div class="post-meta meta-tags">
没有标签
</div>
</article>
</div>
<footer id=footer>
<div>
&copy; 2021 <a href=https://blogtest.kangkang.org>Kxn's eXercise Notes By kxn</a>
</div>
<br>
<div>
<div class=github-badge>
<a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
</div>
<div class=github-badge>
<a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
</div>
<div class=github-badge>
<a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
</div>
</div>
</footer>
<script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:!0}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script src=/js/douban.js></script>
</div>
<div id=secondary>
<section class=widget>
<form id=search action=https://blogtest.kangkang.org/search/ method=get accept-charset=utf-8 target=_blank _lpchecked=1>
<input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://blogtest.kangkang.org>
<button type=submit class="submit icon-search"></button>
</form>
</section>
<section class=widget>
<h3 class=widget-title>最近文章</h3>
<ul class=widget-list>
<li>
<a href=https://blogtest.kangkang.org/post/557.html title="MSI B550 暗黑版跑黑苹果">MSI B550 暗黑版跑黑苹果</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/553.html title="最简单的打造一台能够 RenderDoc 的手机">最简单的打造一台能够 RenderDoc 的手机</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/541.html title="编译 RenderDoc 的安卓 apk(带interceptor-lib)">编译 RenderDoc 的安卓 apk(带interceptor-lib)</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/532.html title=Linux下解决同一硬盘因为连接设备不一样导致扇区大小不一致的问题>Linux下解决同一硬盘因为连接设备不一样导致扇区大小不一致的问题</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/529.html title="RHEL/CentOS/OracleLinux 8  yum 能看到，安装却没有的情况">RHEL/CentOS/OracleLinux 8 yum 能看到，安装却没有的情况</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/521.html title=让服务器响应整个网段中的请求>让服务器响应整个网段中的请求</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/514.html title="不要买技嘉 X570 Gaming X 主板">不要买技嘉 X570 Gaming X 主板</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/509.html title="Golang socket 里面奇怪的 pipe 使用">Golang socket 里面奇怪的 pipe 使用</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/504.html title=用RenderDoc和安卓模拟器抓帧手游>用RenderDoc和安卓模拟器抓帧手游</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/500.html title="解决 Mac 电脑原生 EFI 安装 Windows 启动很慢的问题">解决 Mac 电脑原生 EFI 安装 Windows 启动很慢的问题</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/categories/>分类</a></h3>
<ul class=widget-list>
<li><a href=https://blogtest.kangkang.org/categories/Coding/>Coding (12)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Entertainment/>Entertainment (5)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Network/>Network (33)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Pictures/>Pictures (2)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Software/>Software (27)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Tech-Notes/>Tech Notes (174)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Uncategorized/>Uncategorized (30)</a></li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/tags/>标签</a></h3>
<div class=tagcloud>
<a href=https://blogtest.kangkang.org/tags/.xsession-errors/>.xsession-errors</a>
<a href=https://blogtest.kangkang.org/tags/139/>139</a>
<a href=https://blogtest.kangkang.org/tags/720/>720</a>
<a href=https://blogtest.kangkang.org/tags/CentOS/>CentOS</a>
<a href=https://blogtest.kangkang.org/tags/adsl/>adsl</a>
<a href=https://blogtest.kangkang.org/tags/aliedit/>aliedit</a>
<a href=https://blogtest.kangkang.org/tags/bad-design/>bad design</a>
<a href=https://blogtest.kangkang.org/tags/buggy/>buggy</a>
<a href=https://blogtest.kangkang.org/tags/chdk-a570-canon/>chdk a570 canon</a>
<a href=https://blogtest.kangkang.org/tags/cname/>cname</a>
<a href=https://blogtest.kangkang.org/tags/dns/>dns</a>
<a href=https://blogtest.kangkang.org/tags/error/>error</a>
<a href=https://blogtest.kangkang.org/tags/fail/>fail</a>
<a href=https://blogtest.kangkang.org/tags/filesort/>filesort</a>
<a href=https://blogtest.kangkang.org/tags/fragrance-hill/>fragrance hill</a>
<a href=https://blogtest.kangkang.org/tags/google-chrome/>google chrome</a>
<a href=https://blogtest.kangkang.org/tags/gps/>gps</a>
<a href=https://blogtest.kangkang.org/tags/gzip/>gzip</a>
<a href=https://blogtest.kangkang.org/tags/half-duplex/>half duplex</a>
<a href=https://blogtest.kangkang.org/tags/ipv6-isatap-fedora/>ipv6 isatap fedora</a>
<a href=https://blogtest.kangkang.org/tags/javascript/>javascript</a>
<a href=https://blogtest.kangkang.org/tags/jtag-debrick-dell-2300-%E6%97%A0%E7%BA%BF%E8%B7%AF%E7%94%B1%E5%99%A8-%E4%BF%AE%E5%A4%8D-openwrt/>jtag debrick dell 2300 无线路由器 修复 openwrt</a>
<a href=https://blogtest.kangkang.org/tags/mobile-trail-explorer/>mobile trail explorer</a>
<a href=https://blogtest.kangkang.org/tags/mysql/>mysql</a>
<a href=https://blogtest.kangkang.org/tags/mysql-replication/>mysql replication</a>
<a href=https://blogtest.kangkang.org/tags/optimize/>optimize</a>
<a href=https://blogtest.kangkang.org/tags/performance/>performance</a>
<a href=https://blogtest.kangkang.org/tags/pushmail/>pushmail</a>
<a href=https://blogtest.kangkang.org/tags/query-cache/>query cache</a>
<a href=https://blogtest.kangkang.org/tags/qwerty/>qwerty</a>
<a href=https://blogtest.kangkang.org/tags/remote-backup/>remote backup</a>
<a href=https://blogtest.kangkang.org/tags/shortcut/>shortcut</a>
<a href=https://blogtest.kangkang.org/tags/slow-machine/>slow machine</a>
<a href=https://blogtest.kangkang.org/tags/sony-ericsson-m600i/>sony ericsson m600i</a>
<a href=https://blogtest.kangkang.org/tags/ssl/>ssl</a>
<a href=https://blogtest.kangkang.org/tags/trackback/>trackback</a>
<a href=https://blogtest.kangkang.org/tags/ucweb-6.3/>ucweb 6.3</a>
<a href=https://blogtest.kangkang.org/tags/unstable/>unstable</a>
<a href=https://blogtest.kangkang.org/tags/wildcard/>wildcard</a>
<a href=https://blogtest.kangkang.org/tags/xp/>xp</a>
<a href=https://blogtest.kangkang.org/tags/%E4%B8%93%E4%B8%9A%E7%89%88/>专业版</a>
<a href=https://blogtest.kangkang.org/tags/%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/>安全问题</a>
<a href=https://blogtest.kangkang.org/tags/%E6%8B%9B%E8%A1%8C/>招行</a>
<a href=https://blogtest.kangkang.org/tags/%E6%96%90%E8%AE%AFN1/>斐讯N1</a>
<a href=https://blogtest.kangkang.org/tags/%E9%A9%B1%E5%8A%A8/>驱动</a>
</div>
</section>
<section class=widget>
<h3 class=widget-title>友情链接</h3>
<ul class=widget-list>
<li>
<a target=_blank href=https://blog.kangkang.net/ title=我的非技术blog>我的非技术blog</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title>其它</h3>
<ul class=widget-list>
<li><a href=https://blogtest.kangkang.org/index.xml>文章 RSS</a></li>
</ul>
</section>
</div>
</div>
</div>
</div>
</body>
</html>