<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=referrer content="no-referrer-when-downgrade">
<title>无责任闲谈 – LD_PRELOAD 和模块内调用 | Kxn's eXercise Notes</title>
<meta property="og:title" content="无责任闲谈 – LD_PRELOAD 和模块内调用 - Kxn's eXercise Notes">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2008-03-11T08:19:07+08:00">
<meta property="article:modified_time" content="2008-03-11T08:19:07+08:00">
<meta name=Keywords content>
<meta name=description content="无责任闲谈 – LD_PRELOAD 和模块内调用">
<meta name=author content="kxn">
<meta property="og:url" content="https://blogtest.kangkang.org/post/192.html">
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=stylesheet href=/css/normalize.css>
<link rel=stylesheet href=/css/style.css>
<script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link rel=stylesheet href=/css/douban.css>
<link rel=stylesheet href=/css/other.css>
</head>
<body>
<header id=header class=clearfix>
<div class=container>
<div class=col-group>
<div class=site-name>
<a id=logo href=https://blogtest.kangkang.org>
Kxn's eXercise Notes
</a>
<p class=description>Knowledge Sharing</p>
</div>
<div>
<nav id=nav-menu class=clearfix>
<a class=current href=https://blogtest.kangkang.org>首页</a>
<a href=https://blogtest.kangkang.org/archives/ title=归档>归档</a>
<a href=https://blogtest.kangkang.org/about-me/ title="About Me">About Me</a>
</nav>
</div>
</div>
</div>
</header>
<div id=body>
<div class=container>
<div class=col-group>
<div class=col-8 id=main>
<div class=res-cons>
<article class=post>
<header>
<h1 class=post-title>无责任闲谈 – LD_PRELOAD 和模块内调用</h1>
</header>
<date class="post-meta meta-date">
2008年3月11日
</date>
<div class=post-meta>
<span>|</span>
<span class=meta-category><a href=/categories/Tech-Notes>Tech Notes</a></span>
</div>
<div class=post-meta>
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span>
</div>
<div class=post-content>
<p><strong>无责任闲谈 -</strong> <strong>LD_PRELOAD 和模块内调用</strong></p>
<p>这个问题的提出是因为某天伟大的布总问了我一个问题。</p>
<p>如果某个 .so 里面有两个函数， 一个 foo ，一个 bar， bar 调用了 foo ，那么 bar 调用 foo 的地方应该是直接生成对 foo 的调用呢？还是通过跳转表来实现呢？</p>
<p>我们讨论了一下，都觉得如果没有加 -fPIC 的话，这个怎么也不应该通过跳转表来实现。但是布总却发现，如果之前弄一个 inject.so 里面包含一个叫做 foo 的函数，然后通过 LD_PRELOAD 来预先加载，不管编译时候有没有加 -fPIC，调用 bar 的时候，调用的都是 inject.so 里面的 foo 函数。这就有点奇怪了，ld-linux.so 怎么会去修改原来 .so 中 foo 对 bar 的调用呢？</p>
<p>还是反汇编一下看看吧：</p>
<p>不带 -fPIC</p>
<p>00000498 :<br>
498: 55 push %ebp<br>
499: 89 e5 mov %esp,%ebp<br>
49b: 5d pop %ebp<br>
49c: c3 ret</p>
<p>0000049d :<br>
49d: 55 push %ebp<br>
49e: 89 e5 mov %esp,%ebp<br>
4a0: e8 fc ff ff ff call 4a1 &lt;bar+0x4><br>
4a5: 5d pop %ebp</p>
<p>带 -fPIC<br>
000004a8 :<br>
4a8: 55 push %ebp<br>
4a9: 89 e5 mov %esp,%ebp<br>
4ab: 5d pop %ebp<br>
4ac: c3 ret</p>
<p>000004ad :<br>
4ad: 55 push %ebp<br>
4ae: 89 e5 mov %esp,%ebp<br>
4b0: 53 push %ebx<br>
4b1: 83 ec 04 sub $0x4,%esp<br>
4b4: e8 eb ff ff ff call 4a4 &lt;__i686.get_pc_thunk.bx><br>
4b9: 81 c3 4b 11 00 00 add $0x114b,%ebx<br>
4bf: e8 fc fe ff ff call 3c0 <a href=mailto:foo@plt>foo@plt</a> // PLT thunk<br>
4c4: 83 c4 04 add $0x4,%esp<br>
4c7: 5b pop %ebx<br>
4c8: 5d pop %ebp</p>
<p>其中相关的 PLT 内容如下：</p>
<p>000003c0 <a href=mailto:foo@plt>foo@plt</a>:<br>
3c0: ff a3 10 00 00 00 jmp *0x10(%ebx) // 指向跳转表项的指针<br>
3c6: 68 08 00 00 00 push $0x8<br>
3cb: e9 d0 ff ff ff jmp 3a0 &lt;_init+0x18></p>
<p>-fPIC 的情况很好理解，跳转都是通过 PLT 进行的，直接去修改跳转表中的数据即可。那么没有 -fPIC 的情况，loader 是怎么能够修改调用让他指向另外 .so 里面的函数呢？</p>
<p>从汇编里面可以看出来，没有 -fPIC 的情况下面，对 foo 的调用指向的也不是 foo ，而是一个没有意义的地址，观察 .so 的 reloc 信息可知，有一条 reloc 指向 bar 对 foo 调用的地方，内容是 &ldquo;foo&rdquo;</p>
<p>DYNAMIC RELOCATION RECORDS<br>
OFFSET TYPE VALUE<br>
000015fc R_386_RELATIVE *ABS*<br>
00001600 R_386_RELATIVE *ABS*<br>
000004a1 R_386_PC32 foo</p>
<p>因此在 LD_PRELOAD 的情况下面， loader 会查找 foo 的地址并填入 bar 对 foo 调用的地方。</p>
<p>这种按照名字 reloc 的方式在 Win32 下面似乎没有见到过。Win32 下面 reloc 只是用于修正 DLL 加载以后导致数据指针位置不对的问题，操作方法是简单的把位置上面的值减掉原基址加上新基址，相当于 R_386_RELATIVE 这种类型的 reloc。但是仔细想想，这种 reloc 其实并没有任何必要，RELATIVE 方式已经足够解决问题了，怀疑这个 PC32 的方式，就是单独为了支持 LD_PRELOAD 这一历史遗留产物而设计的。(我比较懒得查阅资料，谁查到了麻烦讲一下)</p>
<p>在 64 位下面，这个把戏不能用了，因为 64bit 下面函数调用一般还只是通过 E8 指令来调用 32 位范围内的地址，而 foo 函数的位置可能离 bar 调用它的地方超过了 2G，因此 ld 遇到这样的 reloc 会报告失败，要求你必须用 -fPIC 来编译。</p>
<p>有人可能会问， -fPIC 了不是会影响性能？这个确实没办法了，在很久以前大家没有意识到需要 module local symbol ，觉得除了 static 的所有函数都全局可见就好了，结果这个习惯就一直继承下来了，虽然现在 ELF 格式中确实支持 module local 的 symbol。但是因为历史上就是这么下来的，为了维持兼容性，只好继续保持这一行为。很多函数并没有跨模块调用的需要，只是因为有跨文件调用就不得不变成非 static 的，在上面说的这种情况下就会受到影响。</p>
<p>一个很土鳖的解决方法就是把所有函数都堆进一个 .c ，然后除了真正需要导出的函数，都改成 static 的。也许 gcc 现在支持什么扩展，可以将符号声明成 module local 的，不过我也是懒得查资料了，有人知道的话，请不吝赐教。 //bow</p>
</div>
<div class="post-meta meta-tags">
没有标签
</div>
</article>
</div>
<footer id=footer>
<div>
&copy; 2021 <a href=https://blogtest.kangkang.org>Kxn's eXercise Notes By kxn</a>
</div>
<br>
<div>
<div class=github-badge>
<a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
</div>
<div class=github-badge>
<a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
</div>
<div class=github-badge>
<a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
</div>
</div>
</footer>
<script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:!0}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script src=/js/douban.js></script>
</div>
<div id=secondary>
<section class=widget>
<form id=search action=https://blogtest.kangkang.org/search/ method=get accept-charset=utf-8 target=_blank _lpchecked=1>
<input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://blogtest.kangkang.org>
<button type=submit class="submit icon-search"></button>
</form>
</section>
<section class=widget>
<h3 class=widget-title>最近文章</h3>
<ul class=widget-list>
<li>
<a href=https://blogtest.kangkang.org/post/557.html title="MSI B550 暗黑版跑黑苹果">MSI B550 暗黑版跑黑苹果</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/553.html title="最简单的打造一台能够 RenderDoc 的手机">最简单的打造一台能够 RenderDoc 的手机</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/541.html title="编译 RenderDoc 的安卓 apk(带interceptor-lib)">编译 RenderDoc 的安卓 apk(带interceptor-lib)</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/532.html title=Linux下解决同一硬盘因为连接设备不一样导致扇区大小不一致的问题>Linux下解决同一硬盘因为连接设备不一样导致扇区大小不一致的问题</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/529.html title="RHEL/CentOS/OracleLinux 8  yum 能看到，安装却没有的情况">RHEL/CentOS/OracleLinux 8 yum 能看到，安装却没有的情况</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/521.html title=让服务器响应整个网段中的请求>让服务器响应整个网段中的请求</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/514.html title="不要买技嘉 X570 Gaming X 主板">不要买技嘉 X570 Gaming X 主板</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/509.html title="Golang socket 里面奇怪的 pipe 使用">Golang socket 里面奇怪的 pipe 使用</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/504.html title=用RenderDoc和安卓模拟器抓帧手游>用RenderDoc和安卓模拟器抓帧手游</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/500.html title="解决 Mac 电脑原生 EFI 安装 Windows 启动很慢的问题">解决 Mac 电脑原生 EFI 安装 Windows 启动很慢的问题</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/categories/>分类</a></h3>
<ul class=widget-list>
<li><a href=https://blogtest.kangkang.org/categories/Coding/>Coding (12)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Entertainment/>Entertainment (5)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Network/>Network (33)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Pictures/>Pictures (2)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Software/>Software (27)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Tech-Notes/>Tech Notes (174)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Uncategorized/>Uncategorized (30)</a></li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/tags/>标签</a></h3>
<div class=tagcloud>
<a href=https://blogtest.kangkang.org/tags/.xsession-errors/>.xsession-errors</a>
<a href=https://blogtest.kangkang.org/tags/139/>139</a>
<a href=https://blogtest.kangkang.org/tags/720/>720</a>
<a href=https://blogtest.kangkang.org/tags/CentOS/>CentOS</a>
<a href=https://blogtest.kangkang.org/tags/adsl/>adsl</a>
<a href=https://blogtest.kangkang.org/tags/aliedit/>aliedit</a>
<a href=https://blogtest.kangkang.org/tags/bad-design/>bad design</a>
<a href=https://blogtest.kangkang.org/tags/buggy/>buggy</a>
<a href=https://blogtest.kangkang.org/tags/chdk-a570-canon/>chdk a570 canon</a>
<a href=https://blogtest.kangkang.org/tags/cname/>cname</a>
<a href=https://blogtest.kangkang.org/tags/dns/>dns</a>
<a href=https://blogtest.kangkang.org/tags/error/>error</a>
<a href=https://blogtest.kangkang.org/tags/fail/>fail</a>
<a href=https://blogtest.kangkang.org/tags/filesort/>filesort</a>
<a href=https://blogtest.kangkang.org/tags/fragrance-hill/>fragrance hill</a>
<a href=https://blogtest.kangkang.org/tags/google-chrome/>google chrome</a>
<a href=https://blogtest.kangkang.org/tags/gps/>gps</a>
<a href=https://blogtest.kangkang.org/tags/gzip/>gzip</a>
<a href=https://blogtest.kangkang.org/tags/half-duplex/>half duplex</a>
<a href=https://blogtest.kangkang.org/tags/ipv6-isatap-fedora/>ipv6 isatap fedora</a>
<a href=https://blogtest.kangkang.org/tags/javascript/>javascript</a>
<a href=https://blogtest.kangkang.org/tags/jtag-debrick-dell-2300-%E6%97%A0%E7%BA%BF%E8%B7%AF%E7%94%B1%E5%99%A8-%E4%BF%AE%E5%A4%8D-openwrt/>jtag debrick dell 2300 无线路由器 修复 openwrt</a>
<a href=https://blogtest.kangkang.org/tags/mobile-trail-explorer/>mobile trail explorer</a>
<a href=https://blogtest.kangkang.org/tags/mysql/>mysql</a>
<a href=https://blogtest.kangkang.org/tags/mysql-replication/>mysql replication</a>
<a href=https://blogtest.kangkang.org/tags/optimize/>optimize</a>
<a href=https://blogtest.kangkang.org/tags/performance/>performance</a>
<a href=https://blogtest.kangkang.org/tags/pushmail/>pushmail</a>
<a href=https://blogtest.kangkang.org/tags/query-cache/>query cache</a>
<a href=https://blogtest.kangkang.org/tags/qwerty/>qwerty</a>
<a href=https://blogtest.kangkang.org/tags/remote-backup/>remote backup</a>
<a href=https://blogtest.kangkang.org/tags/shortcut/>shortcut</a>
<a href=https://blogtest.kangkang.org/tags/slow-machine/>slow machine</a>
<a href=https://blogtest.kangkang.org/tags/sony-ericsson-m600i/>sony ericsson m600i</a>
<a href=https://blogtest.kangkang.org/tags/ssl/>ssl</a>
<a href=https://blogtest.kangkang.org/tags/trackback/>trackback</a>
<a href=https://blogtest.kangkang.org/tags/ucweb-6.3/>ucweb 6.3</a>
<a href=https://blogtest.kangkang.org/tags/unstable/>unstable</a>
<a href=https://blogtest.kangkang.org/tags/wildcard/>wildcard</a>
<a href=https://blogtest.kangkang.org/tags/xp/>xp</a>
<a href=https://blogtest.kangkang.org/tags/%E4%B8%93%E4%B8%9A%E7%89%88/>专业版</a>
<a href=https://blogtest.kangkang.org/tags/%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/>安全问题</a>
<a href=https://blogtest.kangkang.org/tags/%E6%8B%9B%E8%A1%8C/>招行</a>
<a href=https://blogtest.kangkang.org/tags/%E6%96%90%E8%AE%AFN1/>斐讯N1</a>
<a href=https://blogtest.kangkang.org/tags/%E9%A9%B1%E5%8A%A8/>驱动</a>
</div>
</section>
<section class=widget>
<h3 class=widget-title>友情链接</h3>
<ul class=widget-list>
<li>
<a target=_blank href=https://blog.kangkang.net/ title=我的非技术blog>我的非技术blog</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title>其它</h3>
<ul class=widget-list>
<li><a href=https://blogtest.kangkang.org/index.xml>文章 RSS</a></li>
</ul>
</section>
</div>
</div>
</div>
</div>
</body>
</html>