<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=referrer content="no-referrer-when-downgrade">
<title>LVS 直接路由方式简单配置，以及响应时间抖动情况 | Kxn's eXercise Notes</title>
<meta property="og:title" content="LVS 直接路由方式简单配置，以及响应时间抖动情况 - Kxn's eXercise Notes">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2006-02-12T13:12:42+08:00">
<meta property="article:modified_time" content="2006-02-12T13:12:42+08:00">
<meta name=Keywords content>
<meta name=description content="LVS 直接路由方式简单配置，以及响应时间抖动情况">
<meta name=author content="kxn">
<meta property="og:url" content="https://blogtest.kangkang.org/post/69.html">
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=stylesheet href=/css/normalize.css>
<link rel=stylesheet href=/css/style.css>
<script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link rel=stylesheet href=/css/douban.css>
<link rel=stylesheet href=/css/other.css>
</head>
<body>
<header id=header class=clearfix>
<div class=container>
<div class=col-group>
<div class=site-name>
<a id=logo href=https://blogtest.kangkang.org>
Kxn's eXercise Notes
</a>
<p class=description>Knowledge Sharing</p>
</div>
<div>
<nav id=nav-menu class=clearfix>
<a class=current href=https://blogtest.kangkang.org>首页</a>
<a href=https://blogtest.kangkang.org/archives/ title=归档>归档</a>
<a href=https://blogtest.kangkang.org/about-me/ title="About Me">About Me</a>
</nav>
</div>
</div>
</div>
</header>
<div id=body>
<div class=container>
<div class=col-group>
<div class=col-8 id=main>
<div class=res-cons>
<article class=post>
<header>
<h1 class=post-title>LVS 直接路由方式简单配置，以及响应时间抖动情况</h1>
</header>
<date class="post-meta meta-date">
2006年2月12日
</date>
<div class=post-meta>
<span>|</span>
<span class=meta-category><a href=/categories/Network>Network</a></span>
<span class=meta-category><a href=/categories/Tech-Notes>Tech Notes</a></span>
</div>
<div class=post-meta>
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span>
</div>
<div class=post-content>
<p>最近发现 F5 这样的负载均衡设备可能请求时间会出现抖动现象，最长的请求经常可以达到好几秒。考虑到 F5 会对所有数据进行 NAT ，有可能处理能力不足，打算研究一下 LVS 会不会有类似现象。</p>
<p>小知识：什么是 LVS?</p>
<p><a href=http://www.linuxvirtualserver.org title="Linux Virtual Server">LVS</a> 是 Linux Virtual Server 的缩写，是章文嵩主持开发的基于 Linux 的类似 F5 这样的连接管理软件，它将接收到的数据包进行部分修改后，发送给后端多台服务器，实现了多台服务器共享同一个 IP 的效果，通过一些配套的 HA 软件互相监测，可以自动剔除失败的后端结点，或者启动备份的前端转发系统。为了避免所有数据都经过前端转发结点造成瓶颈，LVS 在类似   F5 那样的 NAT 模式之上，还提供了隧道模式和直接路由模式两种配置方式，后两种方式巧妙的利用了 Linux kernel 的路由处理逻辑和交换机的工作原理，使得只有入流量经过转发结点，出流量直接从后端处理结点返回给用户。一般 WWW  服务都是出流量远大于入流量，这种情况下面 LVS 可以获得很好的性能。</p>
<p>LVS 的直接路由模式配置：</p>
<p>LVS 直接路由模式是性能最好的一种方式，他的工作原理是这样的,  服务入口 IP 配置在转发结点上面，这样入流量都会被交换机送到转发结点上面，转发结点上面 LVS 模块会处理入流量数据，跟踪其中的 TCP 连接，将这些 TCP  连接数据分发到多台后端上面，后端的 Linux 系统在自己的 lo 设备上面也绑定服务入口 IP ，并打开 IP 转发，最后还要加一条路由，将服务入口 IP 指向 lo 设备上面，从前端发送过来的数据被后端收到以后，后端机器按照路由转发数据, 数据就被转发到 lo 设备上面，因为 lo 设备绑定了服务入口 IP, 这些数据就被后端机器的协议栈捡起来了。后端机器处理完数据以后，将数据发送到外网路由器上面直接发送回客户端。</p>
<p>从以上过程可以看出来，LVS 的直接路由模式有这些特点：</p>
<p>1: 前端处理逻辑比起 NAT 模式来要简单一些，只需要跟踪连接，并修改 mac 就可以。</p>
<p>2: 依赖于后端操作系统的路由功能，</p>
<p>3: 后端机器要和前端机器处于同一局域网内，否则前端无法通过不修改网络层数据来将数据发送给后端。</p>
<p>LVS 的简单配置方法，假设公共服务 IP 是 10.0.0.10, 前端机器是   10.0.0.11, 后端机器是 10.0.0.12-14, 前端机器上面已经安装了 ipvsadm 包，内核也已经编译支持 LVS, 配置方法如下：</p>
<p># 打开前端机器的 ip_forward , 这个是 LVS 需要的<br>
echo 1 > /proc/sys/net/ipv4/ip_forward<br>
# 添加一个位于公网 IP 80 端口的虚拟服务, 负载均衡协议是 weighted lease connection<br>
ipvsadm -A -t 10.0.0.10:80 -s wlc<br>
# 添加后端 IP 们, -g 表明使用的是 direct routing 模式<br>
ipvsadm -a -t 10.0.0.10:80 -r 10.0.0.12 -g<br>
ipvsadm -a -t 10.0.0.10:80 -r 10.0.0.13 -g<br>
ipvsadm -a -t 10.0.0.10:80 -r 10.0.0.14 -g</p>
<p>后端机器上面</p>
<p># 打开 ip_forward<br>
echo 1 > /proc/sys/net/ipv4/ip_forward<br>
# 防止后端机器应答虚拟 IP 的 arp 信息<br>
echo &lsquo;2&rsquo; > /proc/sys/net/ipv4/conf/lo/arp_announce<br>
echo &lsquo;1&rsquo; > /proc/sys/net/ipv4/conf/lo/arp_ignore<br>
echo &lsquo;2&rsquo; > /proc/sys/net/ipv4/conf/all/arp_announce<br>
echo &lsquo;1&rsquo; > /proc/sys/net/ipv4/conf/all/arp_ignore</p>
<p># 在 lo:0 上面配置虚拟 IP<br>
ifconfig lo:0 10.0.0.10 netmask 255.255.255.255<br>
# 增加到 lo:0 的路由<br>
route add -host 10.0.0.10 dev lo:0<br>
如此 LVS 应该就工作正常了，可惜用 ab 的测试结果并不是非常好，后端用 squid 来做服务，用相同的压力压在单台 squid 上面一点都没有抖动现象，通过 LVS 打，马上就能看出来抖动。sigh</p>
</div>
<div class="post-meta meta-tags">
没有标签
</div>
</article>
</div>
<footer id=footer>
<div>
&copy; 2021 <a href=https://blogtest.kangkang.org>Kxn's eXercise Notes By kxn</a>
</div>
<br>
<div>
<div class=github-badge>
<a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
</div>
<div class=github-badge>
<a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
</div>
<div class=github-badge>
<a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
</div>
</div>
</footer>
<script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:!0}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script src=/js/douban.js></script>
</div>
<div id=secondary>
<section class=widget>
<form id=search action=https://blogtest.kangkang.org/search/ method=get accept-charset=utf-8 target=_blank _lpchecked=1>
<input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://blogtest.kangkang.org>
<button type=submit class="submit icon-search"></button>
</form>
</section>
<section class=widget>
<h3 class=widget-title>最近文章</h3>
<ul class=widget-list>
<li>
<a href=https://blogtest.kangkang.org/post/557.html title="MSI B550 暗黑版跑黑苹果">MSI B550 暗黑版跑黑苹果</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/553.html title="最简单的打造一台能够 RenderDoc 的手机">最简单的打造一台能够 RenderDoc 的手机</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/541.html title="编译 RenderDoc 的安卓 apk(带interceptor-lib)">编译 RenderDoc 的安卓 apk(带interceptor-lib)</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/532.html title=Linux下解决同一硬盘因为连接设备不一样导致扇区大小不一致的问题>Linux下解决同一硬盘因为连接设备不一样导致扇区大小不一致的问题</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/529.html title="RHEL/CentOS/OracleLinux 8  yum 能看到，安装却没有的情况">RHEL/CentOS/OracleLinux 8 yum 能看到，安装却没有的情况</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/521.html title=让服务器响应整个网段中的请求>让服务器响应整个网段中的请求</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/514.html title="不要买技嘉 X570 Gaming X 主板">不要买技嘉 X570 Gaming X 主板</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/509.html title="Golang socket 里面奇怪的 pipe 使用">Golang socket 里面奇怪的 pipe 使用</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/504.html title=用RenderDoc和安卓模拟器抓帧手游>用RenderDoc和安卓模拟器抓帧手游</a>
</li>
<li>
<a href=https://blogtest.kangkang.org/post/500.html title="解决 Mac 电脑原生 EFI 安装 Windows 启动很慢的问题">解决 Mac 电脑原生 EFI 安装 Windows 启动很慢的问题</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/categories/>分类</a></h3>
<ul class=widget-list>
<li><a href=https://blogtest.kangkang.org/categories/Coding/>Coding (12)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Entertainment/>Entertainment (5)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Network/>Network (33)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Pictures/>Pictures (2)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Software/>Software (27)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Tech-Notes/>Tech Notes (174)</a></li>
<li><a href=https://blogtest.kangkang.org/categories/Uncategorized/>Uncategorized (30)</a></li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/tags/>标签</a></h3>
<div class=tagcloud>
<a href=https://blogtest.kangkang.org/tags/.xsession-errors/>.xsession-errors</a>
<a href=https://blogtest.kangkang.org/tags/139/>139</a>
<a href=https://blogtest.kangkang.org/tags/720/>720</a>
<a href=https://blogtest.kangkang.org/tags/CentOS/>CentOS</a>
<a href=https://blogtest.kangkang.org/tags/adsl/>adsl</a>
<a href=https://blogtest.kangkang.org/tags/aliedit/>aliedit</a>
<a href=https://blogtest.kangkang.org/tags/bad-design/>bad design</a>
<a href=https://blogtest.kangkang.org/tags/buggy/>buggy</a>
<a href=https://blogtest.kangkang.org/tags/chdk-a570-canon/>chdk a570 canon</a>
<a href=https://blogtest.kangkang.org/tags/cname/>cname</a>
<a href=https://blogtest.kangkang.org/tags/dns/>dns</a>
<a href=https://blogtest.kangkang.org/tags/error/>error</a>
<a href=https://blogtest.kangkang.org/tags/fail/>fail</a>
<a href=https://blogtest.kangkang.org/tags/filesort/>filesort</a>
<a href=https://blogtest.kangkang.org/tags/fragrance-hill/>fragrance hill</a>
<a href=https://blogtest.kangkang.org/tags/google-chrome/>google chrome</a>
<a href=https://blogtest.kangkang.org/tags/gps/>gps</a>
<a href=https://blogtest.kangkang.org/tags/gzip/>gzip</a>
<a href=https://blogtest.kangkang.org/tags/half-duplex/>half duplex</a>
<a href=https://blogtest.kangkang.org/tags/ipv6-isatap-fedora/>ipv6 isatap fedora</a>
<a href=https://blogtest.kangkang.org/tags/javascript/>javascript</a>
<a href=https://blogtest.kangkang.org/tags/jtag-debrick-dell-2300-%E6%97%A0%E7%BA%BF%E8%B7%AF%E7%94%B1%E5%99%A8-%E4%BF%AE%E5%A4%8D-openwrt/>jtag debrick dell 2300 无线路由器 修复 openwrt</a>
<a href=https://blogtest.kangkang.org/tags/mobile-trail-explorer/>mobile trail explorer</a>
<a href=https://blogtest.kangkang.org/tags/mysql/>mysql</a>
<a href=https://blogtest.kangkang.org/tags/mysql-replication/>mysql replication</a>
<a href=https://blogtest.kangkang.org/tags/optimize/>optimize</a>
<a href=https://blogtest.kangkang.org/tags/performance/>performance</a>
<a href=https://blogtest.kangkang.org/tags/pushmail/>pushmail</a>
<a href=https://blogtest.kangkang.org/tags/query-cache/>query cache</a>
<a href=https://blogtest.kangkang.org/tags/qwerty/>qwerty</a>
<a href=https://blogtest.kangkang.org/tags/remote-backup/>remote backup</a>
<a href=https://blogtest.kangkang.org/tags/shortcut/>shortcut</a>
<a href=https://blogtest.kangkang.org/tags/slow-machine/>slow machine</a>
<a href=https://blogtest.kangkang.org/tags/sony-ericsson-m600i/>sony ericsson m600i</a>
<a href=https://blogtest.kangkang.org/tags/ssl/>ssl</a>
<a href=https://blogtest.kangkang.org/tags/trackback/>trackback</a>
<a href=https://blogtest.kangkang.org/tags/ucweb-6.3/>ucweb 6.3</a>
<a href=https://blogtest.kangkang.org/tags/unstable/>unstable</a>
<a href=https://blogtest.kangkang.org/tags/wildcard/>wildcard</a>
<a href=https://blogtest.kangkang.org/tags/xp/>xp</a>
<a href=https://blogtest.kangkang.org/tags/%E4%B8%93%E4%B8%9A%E7%89%88/>专业版</a>
<a href=https://blogtest.kangkang.org/tags/%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/>安全问题</a>
<a href=https://blogtest.kangkang.org/tags/%E6%8B%9B%E8%A1%8C/>招行</a>
<a href=https://blogtest.kangkang.org/tags/%E6%96%90%E8%AE%AFN1/>斐讯N1</a>
<a href=https://blogtest.kangkang.org/tags/%E9%A9%B1%E5%8A%A8/>驱动</a>
</div>
</section>
<section class=widget>
<h3 class=widget-title>友情链接</h3>
<ul class=widget-list>
<li>
<a target=_blank href=https://blog.kangkang.net/ title=我的非技术blog>我的非技术blog</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title>其它</h3>
<ul class=widget-list>
<li><a href=https://blogtest.kangkang.org/index.xml>文章 RSS</a></li>
</ul>
</section>
</div>
</div>
</div>
</div>
</body>
</html>