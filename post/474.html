<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=referrer content="no-referrer-when-downgrade">
<title>我家云/粒子云刷CentOS | Kxn's eXercise Notes</title>
<meta property="og:title" content="我家云/粒子云刷CentOS - Kxn's eXercise Notes">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-08-04T14:03:03+08:00">
<meta property="article:modified_time" content="2020-08-04T14:03:03+08:00">
<meta name=Keywords content>
<meta name=description content="我家云/粒子云刷CentOS">
<meta name=author content="kxn">
<meta property="og:url" content="https://blog.kangkang.org/post/474.html">
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=stylesheet href=/css/normalize.css>
<link rel=stylesheet href=/css/style.css>
<script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link rel=stylesheet href=/css/douban.css>
<link rel=stylesheet href=/css/other.css>
</head>
<body>
<header id=header class=clearfix>
<div class=container>
<div class=col-group>
<div class=site-name>
<a id=logo href=https://blog.kangkang.org>
Kxn's eXercise Notes
</a>
<p class=description>Knowledge Sharing</p>
</div>
<div>
<nav id=nav-menu class=clearfix>
<a class=current href=https://blog.kangkang.org>首页</a>
<a href=https://blog.kangkang.org/archives/ title=归档>归档</a>
<a href=https://blog.kangkang.org/about-me/ title="About Me">About Me</a>
</nav>
</div>
</div>
</div>
</header>
<div id=body>
<div class=container>
<div class=col-group>
<div class=col-8 id=main>
<div class=res-cons>
<article class=post>
<header>
<h1 class=post-title>我家云/粒子云刷CentOS</h1>
</header>
<date class="post-meta meta-date">
2020年8月4日
</date>
<div class=post-meta>
<span>|</span>
<span class=meta-category><a href=/categories/Tech-Notes>Tech Notes</a></span>
</div>
<div class=post-meta>
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span>
</div>
<div class=post-content>
<p>最近又发现一个矿渣，我家云或者粒子云，配置是 RK3328 + 1G RAM + 8G EMMC。单看配置确实没啥看的价值，但是好就好在他可以内置一个 3.5 寸的硬盘，磁盘读写速度比起只有 USB 2.0 的 N1 盒子来说完全不可同日而语。矿难以后价格一度降到五六十块包邮，然而我总是后知后觉，发现的时候价格又都涨到 80 左右包邮了，无论如何，如果有接硬盘的需求，比现在入 N1 还是合算一些的。</p>
<p>这个东西其实硬件是有毛病会掉盘的，看了一下论坛上的说法，基本都是说供电有问题，USB -> SATA 的转换芯片本身也有问题（RK3328 不支持 SATA，他的内置 SATA 是用 USB3 加上转换芯片实现的）。不过我们要求不高，不会疯狂一次性给硬盘写入上 T 的数据，硬盘也用功耗比较低的西数绿盘之类的话就还好，至少我目前还没遇到掉盘的问题。</p>
<p>刷机过程和固件网上都有非常多了，这里不再啰嗦，网上固件基本都是弄好的 NAS 系统，要么就是基于 Debian 的 Armbian，但是对于我们 CentOS 爱好者来说，用着实在是不爽，所以就有了这篇文章，讲如何用 Armbian 的镜像和 CentOS 的 root 文件系统杂交出来一个 CentOS 的镜像给我家云用。</p>
<p>需要手边有一个可用的 Linux 系统</p>
<p>首先需要获得一个我家云可用的 Armbian 镜像，这里推荐 ride_wind 的 Armbian 固件，下载地址 <a href=https://cloud.189.cn/t/vA736bn2EfEb>https://cloud.189.cn/t/vA736bn2EfEb</a> 密码 3997</p>
<p>里面 Armbian 开头的，看起来长得顺眼的下一个就可以，比如 Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.7z 。解开得到 Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img</p>
<p>此外我们还需要一个 CentOS 7 的镜像， 8 里面 aarch64 被合并进主流了，所以就没人做根文件系统镜像了，只有启动的 iso，当然也不是不能做，就是麻烦很多，我们先用现成的 7 来做。</p>
<p>下载链接</p>
<blockquote>
<p><a href=http://mirrors.aliyun.com/centos-altarch/7.8.2003/isos/aarch64/images/CentOS-Userland-7-aarch64-generic-Minimal-2003-sda.raw.xz>http://mirrors.aliyun.com/centos-altarch/7.8.2003/isos/aarch64/images/CentOS-Userland-7-aarch64-generic-Minimal-2003-sda.raw.xz</a></p>
</blockquote>
<p>将两个文件都复制到 linux 系统下面，CentOS 的镜像需要用 xz -d 解压缩一下</p>
<blockquote>
<p>xz -d CentOS-Userland-7-aarch64-generic-Minimal-2003-sda.raw.xz</p>
</blockquote>
<p>先研究 Armbian 的镜像，用 fdisk 看一下这个镜像里面的样子</p>
<blockquote>
<p>fdisk Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img</p>
</blockquote>
<p>大概会出现如下结果，用 p 命令查看现在分区状态</p>
<blockquote>
<p>Welcome to fdisk (util-linux 2.32.1).<br>
Changes will remain in memory only, until you decide to write them.<br>
Be careful before using the write command.</p>
<p>Command (m for help): p<br>
Disk Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img: 1.3 GiB, 1413480448 bytes, 2760704 sectors<br>
Units: sectors of 1 * 512 = 512 bytes<br>
Sector size (logical/physical): 512 bytes / 512 bytes<br>
I/O size (minimum/optimal): 512 bytes / 512 bytes<br>
Disklabel type: dos<br>
Disk identifier: 0xbfdae994</p>
<p>Device Boot Start End Sectors Size Id Type<br>
Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img1 32768 2760703 2727936 1.3G 83 Linux</p>
</blockquote>
<p>注意到没有这个分区开始位置比较靠后，在 32768 扇区位置， 32768 * 512 = 16M ，也就是说这个镜像前面 16M 不在分区里面，应该都是 bootloader 一类的。我们把它 mount 上看看啥样子</p>
<blockquote>
<p>losetup -o 16777216 -f Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img<br>
losetup -a<br>
/dev/loop0: [2049]:29097987 (/data/share/tmp/Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img), offset 16777216<br>
mount /dev/loop0 /mnt # 这里不要照抄，要看 losetup -a 出来结果里面对应的 loop 设备是哪个</p>
</blockquote>
<p>然后进入 /mnt 就可以看到分区里面的内容了。</p>
<p>我们的基本思路是用 Armbian 的内核和 CentOS 的文件系统杂交，所以 Armbian 这个文件系统里面对我们有用处的就是内核和对应的模块，我们先把他 tar 出来备用，在 /mnt 下面执行</p>
<blockquote>
<p>tar czf /tmp/armbian.tar.gz boot/ usr/lib/modules usr/lib/firmware</p>
</blockquote>
<p>之后就可以开心的把 armbian 文件系统都给删光光了。</p>
<blockquote>
<p>rm -rf /mnt/* # 千万不要敲错。。。</p>
</blockquote>
<p>在往镜像里面拷贝之前还需要做个事情，就是把这个镜像扩一下容，要不然放不下 CentOS。。</p>
<blockquote>
<p>cd /data/share/tmp # 你放 armbian 镜像的路径<br>
umount /mnt<br>
losetup -d /dev/loop0 # 同样不要照抄，和前面的保持一致<br>
dd if=/dev/zero bs=1M count=2048 &#187; Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img</p>
</blockquote>
<p>用 fdisk 将其扩容</p>
<blockquote>
<p>fdisk Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img</p>
</blockquote>
<p>然后用 d 直接删掉分区，再用 n 重建，重建的时候，Start 记得写 32768，之前我们有提到过，镜像前面 16M 是保留的。其余都用默认就可以<br>
最后 w 写入。<br>
大概类似下面这个吧，供参考</p>
<blockquote>
<p>Welcome to fdisk (util-linux 2.32.1).<br>
Changes will remain in memory only, until you decide to write them.<br>
Be careful before using the write command.</p>
<p>Command (m for help): p<br>
Disk Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img: 3.3 GiB, 3560964096 bytes, 6955008 sectors<br>
Units: sectors of 1 * 512 = 512 bytes<br>
Sector size (logical/physical): 512 bytes / 512 bytes<br>
I/O size (minimum/optimal): 512 bytes / 512 bytes<br>
Disklabel type: dos<br>
Disk identifier: 0xbfdae994</p>
<p>Device Boot Start End Sectors Size Id Type<br>
Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img1 32768 2760703 2727936 1.3G 83 Linux</p>
<p>Command (m for help): <strong>d</strong><br>
Selected partition 1<br>
Partition 1 has been deleted.</p>
<p>Command (m for help): <strong>n</strong><br>
Partition type<br>
p primary (0 primary, 0 extended, 4 free)<br>
e extended (container for logical partitions)<br>
Select (default p): <strong>p</strong><br>
Partition number (1-4, default 1): <strong>1</strong><br>
First sector (2048-2760703, default 2048): <strong>32768</strong><br>
Last sector, +sectors or +size{K,M,G,T,P} (32768-6955007, default 6955007):</p>
<p>Created a new partition 1 of type &lsquo;Linux&rsquo; and of size 3.3 GiB.<br>
Partition #1 contains a ext4 signature.</p>
<p>Do you want to remove the signature? [Y]es/[N]o: <strong>n</strong></p>
<p>Command (m for help): <strong>w</strong></p>
<p>The partition table has been altered.<br>
Syncing disks.</p>
</blockquote>
<blockquote>
<p>losetup -o 16777216 -f Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img<br>
losetup -a<br>
/dev/loop0: [2049]:29097987 (/data/share/tmp/Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img), offset 16777216</p>
</blockquote>
<p>先别着急 mount，文件系统还没有扩容</p>
<blockquote>
<p>e2fsck -f -y /dev/loop0<br>
resize2fs /dev/loop0</p>
</blockquote>
<p>然后就可以 mount 了</p>
<blockquote>
<p>mkdir /mnt/dst<br>
mount /dev/loop0 /mnt/dst</p>
</blockquote>
<p>下面需要把 CentOS 的镜像也给挂载上，这个镜像里面有分区，所以稍微麻烦点</p>
<p>losetup -f CentOS-Userland-7-aarch64-generic-Minimal-2003-sda.raw</p>
<p>用 losetup -a 查看对应的 loop 设备，假设为 /dev/loop1</p>
<blockquote>
<p>partprobe /dev/loop1<br>
mkdir /mnt/src<br>
mount /dev/loop1p4 /mnt/src # 这个镜像的第四个分区才是 linux root</p>
</blockquote>
<p>下面我们需要复制 CentOS 里面所有文件到 Armbian 的文件系统，为了保持原来的链接之类有效，直接用 tar 来全部同步</p>
<blockquote>
<p>cd /mnt/src<br>
tar c | tar x -C ../dst</p>
</blockquote>
<p>接下来删掉 CentOS 里面的内核和模块之类，用刚才备份的文件覆盖回去</p>
<blockquote>
<p>cd /mnt/dst<br>
rm -rf boot usr/lib/modules usr/lib/firmware<br>
tar zxf /tmp/armbian.tar.gz</p>
</blockquote>
<p>现在 CentOS 文件复制基本完成了，但是不要着急，还差最后一步，CentOS 根分区在 fstab 里面是靠 UUID 加载的， Armbian 分区的 UUID 肯定不一样，如果不调整会导致无法进系统。需要编辑一下 fstab</p>
<p>首先不要卸载文件系统，用 blkid 查看一下 UUID</p>
<blockquote>
<p>blkid<br>
/dev/loop0: UUID="<strong>575c6079-5569-4591-bb50-3a561c1b32e1</strong>" TYPE=&ldquo;ext4&rdquo;<br>
/dev/loop1: PTUUID=&ldquo;00012ee3&rdquo; PTTYPE=&ldquo;dos&rdquo;<br>
/dev/loop1p1: SEC<em>TYPE=&ldquo;msdos&rdquo; UUID=&ldquo;6085-5C8F&rdquo; TYPE=&ldquo;vfat&rdquo; PARTUUID=&ldquo;00012ee3-01&rdquo;<br>
/dev/loop1p2: LABEL="_/boot" UUID=&ldquo;0f70c468-4087-4ddb-88a6-f19d910a12ac&rdquo; SEC_TYPE=&ldquo;ext2&rdquo; TYPE=&ldquo;ext3&rdquo; PARTUUID=&ldquo;00012ee3-02&rdquo;<br>
/dev/loop1p3: LABEL="_swap" UUID=&ldquo;72adc5ad-d2a7-404f-b107-ab30c646bd51&rdquo; TYPE=&ldquo;swap&rdquo; PARTUUID=&ldquo;00012ee3-03&rdquo;<br>
/dev/loop1p4: LABEL="</em>/" UUID=&ldquo;284014ff-cdc5-4a45-9454-bcefd1e9304f&rdquo; TYPE=&ldquo;ext4&rdquo; PARTUUID=&ldquo;00012ee3-04&rdquo;</p>
</blockquote>
<p>然后编辑 fstab</p>
<blockquote>
<p>cd /mnt/dst<br>
vi etc/fstab</p>
</blockquote>
<p>只保留第一行，其他都删掉，然后第一行的 UUID 改为刚才我们看到 armbian 镜像的那个。</p>
<p>好了，到此就全部结束了。卸载文件系统</p>
<blockquote>
<p>umount /mnt/src<br>
umount /mnt/dst<br>
losetup -D</p>
</blockquote>
<p>之后 Armbian_19.11.3_Chainedbox_stretch_current_5.4.2.img 就变成了一个含有 CentOS 7 的镜像。</p>
<p>在 Windows 下面刷入我家云即可。</p>
</div>
<div class="post-meta meta-tags">
没有标签
</div>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=kxn/kxn.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
<footer id=footer>
<div>
&copy; 2021 <a href=https://blog.kangkang.org>Kxn's eXercise Notes By kxn</a>
</div>
<br>
<div>
<div class=github-badge>
<a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
</div>
<div class=github-badge>
<a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
</div>
<div class=github-badge>
<a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
</div>
</div>
</footer>
<script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:!0}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script src=/js/douban.js></script>
</div>
<div id=secondary>
<section class=widget>
<form id=search action=https://blog.kangkang.org/search/ method=get accept-charset=utf-8 target=_blank _lpchecked=1>
<input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://blog.kangkang.org>
<button type=submit class="submit icon-search"></button>
</form>
</section>
<section class=widget>
<h3 class=widget-title>最近文章</h3>
<ul class=widget-list>
<li>
<a href=https://blog.kangkang.org/post/558.html title=迁移到hugo并且流窜到github>迁移到hugo并且流窜到github</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/557.html title="MSI B550 暗黑版跑黑苹果">MSI B550 暗黑版跑黑苹果</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/553.html title="最简单的打造一台能够 RenderDoc 的手机">最简单的打造一台能够 RenderDoc 的手机</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/541.html title="编译 RenderDoc 的安卓 apk(带interceptor-lib)">编译 RenderDoc 的安卓 apk(带interceptor-lib)</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/532.html title=Linux下解决同一硬盘因为连接设备不一样导致扇区大小不一致的问题>Linux下解决同一硬盘因为连接设备不一样导致扇区大小不一致的问题</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/529.html title="RHEL/CentOS/OracleLinux 8  yum 能看到，安装却没有的情况">RHEL/CentOS/OracleLinux 8 yum 能看到，安装却没有的情况</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/521.html title=让服务器响应整个网段中的请求>让服务器响应整个网段中的请求</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/514.html title="不要买技嘉 X570 Gaming X 主板">不要买技嘉 X570 Gaming X 主板</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/509.html title="Golang socket 里面奇怪的 pipe 使用">Golang socket 里面奇怪的 pipe 使用</a>
</li>
<li>
<a href=https://blog.kangkang.org/post/504.html title=用RenderDoc和安卓模拟器抓帧手游>用RenderDoc和安卓模拟器抓帧手游</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/categories/>分类</a></h3>
<ul class=widget-list>
<li><a href=https://blog.kangkang.org/categories/Coding/>Coding (12)</a></li>
<li><a href=https://blog.kangkang.org/categories/Entertainment/>Entertainment (5)</a></li>
<li><a href=https://blog.kangkang.org/categories/Network/>Network (33)</a></li>
<li><a href=https://blog.kangkang.org/categories/Pictures/>Pictures (2)</a></li>
<li><a href=https://blog.kangkang.org/categories/Software/>Software (27)</a></li>
<li><a href=https://blog.kangkang.org/categories/Tech-Notes/>Tech Notes (175)</a></li>
<li><a href=https://blog.kangkang.org/categories/Uncategorized/>Uncategorized (30)</a></li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/tags/>标签</a></h3>
<div class=tagcloud>
<a href=https://blog.kangkang.org/tags/.xsession-errors/>.xsession-errors</a>
<a href=https://blog.kangkang.org/tags/139/>139</a>
<a href=https://blog.kangkang.org/tags/720/>720</a>
<a href=https://blog.kangkang.org/tags/CentOS/>CentOS</a>
<a href=https://blog.kangkang.org/tags/adsl/>adsl</a>
<a href=https://blog.kangkang.org/tags/aliedit/>aliedit</a>
<a href=https://blog.kangkang.org/tags/bad-design/>bad design</a>
<a href=https://blog.kangkang.org/tags/buggy/>buggy</a>
<a href=https://blog.kangkang.org/tags/chdk-a570-canon/>chdk a570 canon</a>
<a href=https://blog.kangkang.org/tags/cname/>cname</a>
<a href=https://blog.kangkang.org/tags/dns/>dns</a>
<a href=https://blog.kangkang.org/tags/error/>error</a>
<a href=https://blog.kangkang.org/tags/fail/>fail</a>
<a href=https://blog.kangkang.org/tags/filesort/>filesort</a>
<a href=https://blog.kangkang.org/tags/fragrance-hill/>fragrance hill</a>
<a href=https://blog.kangkang.org/tags/google-chrome/>google chrome</a>
<a href=https://blog.kangkang.org/tags/gps/>gps</a>
<a href=https://blog.kangkang.org/tags/gzip/>gzip</a>
<a href=https://blog.kangkang.org/tags/half-duplex/>half duplex</a>
<a href=https://blog.kangkang.org/tags/ipv6-isatap-fedora/>ipv6 isatap fedora</a>
<a href=https://blog.kangkang.org/tags/javascript/>javascript</a>
<a href=https://blog.kangkang.org/tags/jtag-debrick-dell-2300-%E6%97%A0%E7%BA%BF%E8%B7%AF%E7%94%B1%E5%99%A8-%E4%BF%AE%E5%A4%8D-openwrt/>jtag debrick dell 2300 无线路由器 修复 openwrt</a>
<a href=https://blog.kangkang.org/tags/mobile-trail-explorer/>mobile trail explorer</a>
<a href=https://blog.kangkang.org/tags/mysql/>mysql</a>
<a href=https://blog.kangkang.org/tags/mysql-replication/>mysql replication</a>
<a href=https://blog.kangkang.org/tags/optimize/>optimize</a>
<a href=https://blog.kangkang.org/tags/performance/>performance</a>
<a href=https://blog.kangkang.org/tags/pushmail/>pushmail</a>
<a href=https://blog.kangkang.org/tags/query-cache/>query cache</a>
<a href=https://blog.kangkang.org/tags/qwerty/>qwerty</a>
<a href=https://blog.kangkang.org/tags/remote-backup/>remote backup</a>
<a href=https://blog.kangkang.org/tags/shortcut/>shortcut</a>
<a href=https://blog.kangkang.org/tags/slow-machine/>slow machine</a>
<a href=https://blog.kangkang.org/tags/sony-ericsson-m600i/>sony ericsson m600i</a>
<a href=https://blog.kangkang.org/tags/ssl/>ssl</a>
<a href=https://blog.kangkang.org/tags/trackback/>trackback</a>
<a href=https://blog.kangkang.org/tags/ucweb-6.3/>ucweb 6.3</a>
<a href=https://blog.kangkang.org/tags/unstable/>unstable</a>
<a href=https://blog.kangkang.org/tags/wildcard/>wildcard</a>
<a href=https://blog.kangkang.org/tags/xp/>xp</a>
<a href=https://blog.kangkang.org/tags/%E4%B8%93%E4%B8%9A%E7%89%88/>专业版</a>
<a href=https://blog.kangkang.org/tags/%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/>安全问题</a>
<a href=https://blog.kangkang.org/tags/%E6%8B%9B%E8%A1%8C/>招行</a>
<a href=https://blog.kangkang.org/tags/%E6%96%90%E8%AE%AFN1/>斐讯N1</a>
<a href=https://blog.kangkang.org/tags/%E9%A9%B1%E5%8A%A8/>驱动</a>
</div>
</section>
<section class=widget>
<h3 class=widget-title>友情链接</h3>
<ul class=widget-list>
<li>
<a target=_blank href=https://blog.kangkang.net/ title=我的非技术blog>我的非技术blog</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title>其它</h3>
<ul class=widget-list>
<li><a href=https://blog.kangkang.org/index.xml>文章 RSS</a></li>
</ul>
</section>
</div>
</div>
</div>
</div>
</body>
</html>